---
title: "Pressão do Twitter"
output: html_document
---

Este relatório tem como objetivo comparar duas métricas para a pressão do Twitter no Painel Parlamentria. Os dados utilizados são tweets sobre proposições monitoradas pelo Painel no período de 31/12/2018 a 26/04/2021.

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(DT)
library(hrbrthemes)
library(scales)

theme_set(theme_ipsum_rc())

knitr::opts_chunk$set(tidy = FALSE,
                      fig.width = 8,
                      fig.height = 5,
                      echo = FALSE,
                      message = FALSE)
```

```{r results='hide'}
dados <-
  read_csv(here::here("data/ready/pressao.csv")) 

## Proposições que tiveram pressão por mais tempo
siglas <- dados %>% 
  filter(user_count > 0) %>% 
  count(sigla) %>% 
  arrange(desc(n)) %>% 
  head(20)

dados <- dados %>% 
  filter(sigla %in%(siglas$sigla))
```

```{r }
generate_pressao <- function(df) {
  df <- df %>%
    pivot_longer(
      cols = c(pressao, pressao_movel),
      names_to = "tipo_metrica",
      values_to = "value"
    )
  
  COLORS <- c(pressao = "#91bfdb",
              pressao_movel = "#f1a340")
  
  ggplot(df, aes(
    x = date,
    y = value,
    group = tipo_metrica,
    color = tipo_metrica
  )) +
    geom_line() +
    ylab("pressão") +
    xlab("data") +
    scale_color_manual(values = COLORS) +
    scale_x_date(date_labels = "%b/%Y")
} 
```

## Cálculo da pressão

A pressão foi calcula da seguinte forma:

1. Adicionando escala logarítmica ao engajamento;
2. Normalizando o número de usuários diferentes e o engajamento se baseando no maior valor obtido durante a semana (considerando todas as proposições);
3. Calculando a pressão utilizando a fórmula **`pressao = 0.5 * num_usuarios + 0.5 * log2(engajamento)`**.
4. Também utilizamos como métrica a **média móvel da pressão** nas últimas 3 semanas.
  
```{r}
prop_mais_tweetada <- siglas %>% 
  head(1)
```

## `r prop_mais_tweetada$sigla`

Esta proposição foi tweetada por parlamentares e/ou influenciadores por `r prop_mais_tweetada$n` semanas. Abaixo podemos ver sua pressão calculada considerando os dois scores explicados anteriormente.

```{r }
dados %>%
  filter(sigla == prop_mais_tweetada$sigla) %>%
  generate_pressao()
```

```{r}
prop_com_maior_engajamento <- dados %>% 
  arrange(desc(sum_interactions)) %>% 
  head(1)
```

## `r prop_com_maior_engajamento$sigla`

Esta proposição possui o maior engajamento (replies + likes + retweets). 
Na semana do dia `r format(as.Date(prop_com_maior_engajamento$date), "%d/%m/%Y")`, `r prop_com_maior_engajamento$user_count` usuários diferentes tweetaram sobre este projeto de lei e juntos tiveram cerca de 
`r label_number_si(accuracy=0.1)(prop_com_maior_engajamento$sum_interactions)` engajamentos.

```{r }
dados %>%
  filter(sigla == prop_com_maior_engajamento$sigla) %>% 
  generate_pressao()
```

```{r}
prop_mais_usuarios <- dados %>%
  arrange(desc(user_count)) %>% 
  head(1)
```

## `r prop_mais_usuarios$sigla`

Esta proposição possui o maior número de usuários diferentes tweetando sobre em uma semana. Na semana de `r format(as.Date(prop_com_maior_engajamento$date), "%d/%m/%Y")`, `r prop_com_maior_engajamento$user_count` usuários (entre parlamentares e influenciadores) tweetaram sobre esta proposição.

```{r}
dados %>%
  filter(sigla == prop_mais_usuarios$sigla) %>% 
  generate_pressao()
```

## Proposições que possuem pressão por mais tempo

```{r}
dados %>% 
  filter(sigla %in%(siglas %>% head(6) %>% pull(sigla))) %>% 
  generate_pressao() + 
  facet_wrap(~sigla) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

As proposições falam dos seguintes assuntos:

- MPV 870/2019: Reorganização dos órgãos da presidência, dos ministérios e suas atribuições;
- MPV 910/2019: Regularização fundiária e grilagem;
- MPV 936/2020: Programa Emergencial de Manutenção do Emprego e Renda;
- PEC 45/2019: Reforma Tributária;
- PEC 6/2019: Reforma da Previdência;
- PL 3267/2019: Código de Trânsito.


## Tabela com os dados

```{r}
datatable(
  dados %>% select(
    data = date,
    sigla,
    norm_user_count,
    norm_log_sum_interactions,
    pressao,
    pressao_movel
  )
)
```

